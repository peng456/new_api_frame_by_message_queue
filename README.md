# new_api_frame_by_message_queue

基于消息推送的  接口调用策略方案

移动端  ===》 存在 数据缓存  ====>	问题什么时候更新移动端数据    更新同步问题

1、移动端每次主动调用  2、		异步消息回调机制（有修改，发消息给移动端，然后 移动端在调用 接口）

服务器端的框架  =====》 数据修改 ：：数据落地（mysql、redis）  +  发消息（移动端数据更新（消息推送）) 

					    =====》  纯异步化  ，有修改的才拉取信息

IM 长连接   有心跳检测 		在数据包上  透传消息   ====》01010101011001001010101 (位置代表接口，0 代表没有 修改 1 代表数据修改（移动端需要调用接口更细本地数据）)


移动端拉取接口策略算法  ：：    消息事件  +  一定的机制（比如多久没有查询接口则 调用一次） ==》 会一定程度上 减少 消息达到率 非100% 的问题   
                            ===》 感觉这样 ===》 会大大  降低 移动端 调用接口   频率，减少带宽，IO损耗、耗电量 等


服务器端业务房   ———消息——》 	消息服务中心（IM服务器）

			
移动端
需要一套移动端  一套接口调用机制注册机制   

UI     ===》 getLocalCache   ===》 data

服务器推送消息   =====》 具体到某个接口   =====> 接口调用  ===》 返回数据   =====》更新本地数据


移动端框架 分层

UI 
/\
||
||
\/
getLocalCache(一定的算法  决定取自data  or 直接调用接口)
/\
||   \\
||	 \\
||	     \\
||		\\
||		    \\
\/		     \/
data    <=====>  接口调用获取数据   <====> 服务器       
			/\
			||
			||
			\/
		消息事件（在消息队列里面）<===>socket 推送过来的接口拉取消息事件 分发到这个 消息队列里面

未开启 此模式
===》 每次接口调用   ===》 返回UI  && 更新data(判断是否数据修改) 


开启 此模式
（下面只是一个例子，具体算法可以改进。）
===》 1、这个接口上次调用时间 +   最近事件  >   maxtime（比如5s）   ===> 在调用接口  ==》等  && 更新本地数据 +  更新接口最新调用时间
	    2、这个接口上次调用时间 +   最近事件  <   maxtime（比如5s）   ===> 在调用本地数据 ，并 更新调用本地数据的最新时间

！！！一些非幂等性接口  不适合此方法  ===>适合  幂等性一致的接口  （对于 增、改、删的接口不适用，因为消息更能重传，多次发送，不具有幂等性的 接口适合这个框架）

这改动量很大呀！！！  移动端 修改修改&&  服务器端需要修改  ===》 如何无侵入式 框架设计很重要

移动端框架  ：  应该改动很多（那个 分层设计  && 消息队列  &&  IM接入等）

服务器端 ：： 原来的 不需要改变  ===》 只需要 微服务   ====》 发出正确消息事件即可

确保消息到达率 推送的准确率
https://www.zhihu.com/question/52743957 (IM及时通讯消息到达率、push推送准确率如何提高？)


本框架：
1、IM服务器自身确保准确率，到达率
2、框架 的一定机制   ===》来提高 到达率 + 可用性（即消息队列IM,挂了，依然能用）


# 终极目标 ====》 没有  接口回调 那一步   ===》 直接有消息本身带着数据  ===》到达移动端。




